name: Mirror Binaries (Dynamic Sync)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ç›®æ¨™åŒæ­¥ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚ v1.0.8)'
        required: true
        default: 'v1.0.8'
      
      force_filename_version:
        description: 'æ–‡ä»¶åä¸­çš„ç‰ˆæœ¬è™Ÿ (ä¸å«v, é»˜èªè‡ªå‹•æå–)'
        required: false 

permissions:
  contents: write

jobs:
  mirror:
    name: Sync Release
    runs-on: ubuntu-latest
    steps:
      - name: Parse Version Info
        id: meta
        run: |
          # ç²å–è¼¸å…¥çš„æ¨™ç±¤
          TAG="${{ github.event.inputs.tag_name }}"
          echo "TAG=$TAG" >> $GITHUB_ENV
          
          # è‡ªå‹•æå–ç´”æ•¸å­—ç‰ˆæœ¬è™Ÿ (åŽ»æŽ‰ v)
          VERSION="${TAG#v}"
          
          # å¦‚æžœç”¨æˆ¶æ‰‹å‹•æŒ‡å®šäº†æ–‡ä»¶åç‰ˆæœ¬ï¼Œå‰‡å„ªå…ˆä½¿ç”¨
          if [[ -n "${{ github.event.inputs.force_filename_version }}" ]]; then
            VERSION="${{ github.event.inputs.force_filename_version }}"
          fi
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "ðŸŽ¯ ç›®æ¨™æ¨™ç±¤: $TAG"
          echo "ðŸ“‚ å°æ‡‰æ–‡ä»¶åç‰ˆæœ¬: $VERSION"

      - name: Download & Extract Binaries
        run: |
          mkdir -p dist
          
          # å‹•æ…‹æ‹¼æŽ¥ URL
          URL_AMD64="https://github.com/Fangliding/warp-go/releases/download/${TAG}/warp-go_${VERSION}_linux_amd64.tar.gz"
          URL_ARM64="https://github.com/Fangliding/warp-go/releases/download/${TAG}/warp-go_${VERSION}_linux_arm64.tar.gz"
          
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è¼‰ AMD64 from: $URL_AMD64"
          wget -O amd64.tar.gz "$URL_AMD64"
          tar -xzvf amd64.tar.gz
          mv warp-go dist/warp-go_linux_amd64
          rm -f amd64.tar.gz warp-go.conf
          
          echo "â¬‡ï¸ æ­£åœ¨ä¸‹è¼‰ ARM64 from: $URL_ARM64"
          wget -O arm64.tar.gz "$URL_ARM64"
          tar -xzvf arm64.tar.gz
          mv warp-go dist/warp-go_linux_arm64
          rm -f arm64.tar.gz warp-go.conf

      - name: Generate Checksums
        run: |
          cd dist
          sha256sum warp-go_linux_amd64 > warp-go_linux_amd64.sha256
          sha256sum warp-go_linux_arm64 > warp-go_linux_arm64.sha256
          
          echo "=== Checksums ==="
          cat *.sha256

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "warp-go ${{ env.TAG }}"
          body: |
            Synced from upstream version: ${{ env.TAG }}
            Auto-generated by GitHub Actions.
          
          make_latest: true
          
          files: |
            dist/warp-go_linux_amd64
            dist/warp-go_linux_amd64.sha256
            dist/warp-go_linux_arm64
            dist/warp-go_linux_arm64.sha256
